# Browser Emulation

# What is this?

Browser Emulation is used to emulate real user like  DDoS requests to bypass Javascript Challenge, it is most commonly used to bypass JS and cookie based DDoS mitigation.

# How does it effect/bypass mitigation?

* Due to browser emulation's behaviour the WAF(Web Application Firewall) cannot differentiate between a real user's request and a request generated by browser emulation hence the request is not blocked and get passed through the DDoS mitigation stack.

* Mainly when millions of requests gets passed through your server would become unreachable.

*  It uses randomly generated user-agents footprint (Mainly FireFox based).

* Because JS challenge uses **Mouse** movement and **Keyboard** typing to detect if a user is real or not, browser emulation attack can easily emulate both of those movement.


#### A simple example on how does the keyboard/mouse emulation works

Below code uses a libaray called [playwright](https://playwright.dev/docs/api/class-browser) to emulate keyboard and mouse.

```javascript
        browser.newContext({
            locale: locales,
            viewport: fingerprint.screen,
            isMobile: false,
            hasTouch: false,
            inputDevices: [
                {
                    name: 'my-mouse',
                    type: 'mouse',
                    // Emulate a slow mouse movement
                    precision: 10,
                    isTouch: false,
                },
                {
                    name: 'my-keyboard',
                    type: 'keyboard',
                    // Emulate a slow keyboard typing speed
                    layout: 'en-US',
                    repeatDelay: 100,
                    repeatInterval: 50,
                },
            ],
          
```
* It could bypass cookie based mitigation by just grabbing the cookie and using the cookie to send requests.

#### Down below are 2 code examples on how these cookies are takes and how these are used.

```javascript 
        const page = await context.newPage({
            locale: locales,
            deviceScaleFactor: 1,
            userAgent: navAgent
        });
const cookie = (await page.context().cookies(urlT)).map(c => `${c.name}=${c.value}`).join('; ');
```

* This uses the same libary as keyboard and mouse movement emulation as last example above.


```javascript 
            var requestHeaders = {
                ':authority': parsed.host,
                ':method': 'GET',
                ':path': parsed.pathname,
                ':scheme': 'https',
                'User-Agent': ua,
                'Upgrade-Insecure-Requests': '1',
                'Cookie': cookie,
                'Cache-Control': 'max-age=0',
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
                'Accept-Encoding': 'gzip, deflate, br',
                'Accept-Language': 'de,en-US;q=0.7,en;q=0.3',
                'TE': 'trailers'
            }
```
* Now above it makes a request using the cookie obtained from 1st example code.

* Hence now our cookie based mitigation is useless since it will now allow all requests.

# How to Mitigate?

[Ref to DDoS mitigation guide to eliminate](/mitigation/browser-emulation-mitigate.md)

# How to Detect?

[Ref on how to detect these kind of attcks](/detection/browser-emulation-detect.md)

# Links
[Javascript Challenge](https://nginx-extras.getpagespeed.com/modules/js-challenge/)

[Cookie Based DDoS Mitigation](https://nginx-extras.getpagespeed.com/modules/testcookie/)
